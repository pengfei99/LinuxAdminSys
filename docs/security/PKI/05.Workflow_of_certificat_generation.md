# Workflow of certificate management

## 1. Generate root CA private key and certificate

### 1.1 Create a root CA directory structure

```shell
#!/bin/bash

# Define the root CA directory path
ROOT_CA_DIR="./rootCA"

# Create directory structure
mkdir -p "$ROOT_CA_DIR"/{certs,crl,newcerts,private}
chmod 700 "$ROOT_CA_DIR"/private
touch "$ROOT_CA_DIR"/index.txt
echo 1000 > "$ROOT_CA_DIR"/serial
```
### 1.2 Generate root CA private key and certificate

If you already have the private key and certificate, just copy the certificate in `certs` and private key in `private`.

If you don't have, use the below command to generate them. First we will define the parameter of the certificate

```shell
#!/bin/bash

# Exit immediately if a command exits with a non-zero status
set -e

# Define the root CA directory path
ROOT_CA_DIR="/home/pliu/casd_ca"

# cert config value
Country="FR"
City="Malakoff"
Organization="CASD Trust Service"
CommonName="CASD k8s ROOT CA"
# this domain name will be added as subjectAltName
Domain="casd.local"

# Generate Root CA EC private key
openssl ecparam -genkey -name prime256v1 -out "$ROOT_CA_DIR/private/rootCA.key.pem"

# generate a certificate with 
openssl req -new -key "$ROOT_CA_DIR/private/rootCA.key.pem" \
        -x509 -days 3650 -sha256 -extensions v3_ca -out "$ROOT_CA_DIR/certs/rootCA.cert.pem" \
         -subj "/C=$Country/L=$City/O=$Organization/CN=$CommonName" \
         -addext "subjectAltName = DNS:$Domain" \

# Verify the Root CA certificate
openssl x509 -noout -text -in "$ROOT_CA_DIR/certs/rootCA.cert.pem"

chmod 400 "$ROOT_CA_DIR/private/rootCA.key.pem"

echo "Root CA generated successfully."
```


## 2. Generate intermediate private key and certificate

## 3. Client generate private key and csr

## 4. Signing the csr

```shell
#!/bin/bash

# Exit immediately if a command exits with a non-zero status
set -e

# Define the root CA directory path
ROOT_CA_DIR="/home/pliu/casd_ca"
CSR_PATH="$ROOT_CA_DIR/request/wild_card.csr"
openssl x509 -req -copy_extensions copyall -in $CSR_PATH -CA "$ROOT_CA_DIR/certs/rootCA.cert.pem" -CAkey "$ROOT_CA_DIR/private/rootCA.key.pem" -CAcreateserial -out "$ROOT_CA_DIR/certs/newCert.pem" -days 1825 -sha256
```