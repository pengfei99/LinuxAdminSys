# Set up kerberos to use OpenLdap as backend

kerberos can store user login and password. But often we already have OpenLDAP set up for other things, 
such as storing users and groups, adding the `Kerberos attributes` can be beneficial, providing an `integrated story`.

 - Pros:
       - OpenLDAP replication is faster and more robust than the native Kerberos one, based on a cron job
       - Single source for user account management(e.g. pwd, groups, etc.)

- Cons:
        - Setting up the LDAP backend isn’t a trivial task and shouldn’t be attempted by administrators without prior knowledge of OpenLDAP.
        - since krb5kdc is single-threaded there may be `higher latency in servicing requests` when using the OpenLDAP backend


## Pre-requis

Here, we suppose you already have 
- openldap server 
- kerberos server(e.g. kdc, admin-server)

## 1. Configure Openldap to work with Kerberos

We need to install the below packages

```shell
sudo apt install krb5-kdc-ldap krb5-admin-server
```

- krb5-kdc-ldap: This package provides the LDAP backend plugin for the Kerberos Key Distribution Center (KDC). It 
             allows Kerberos to use OpenLDAP or another LDAP server to store
- krb5-admin-server: This package provides the Kerberos admin service (kadmind), which allows administrators 
             to manage the Kerberos database remotely.

### 1.1 Install kerberos schema in openldap server

Openldap needs a `Kerberos schema` to be able to store the necessary object classes and attributes that 
allow LDAP to store Kerberos principals and related data, such as encryption keys, expiration dates, and policy information. 

> Kerberos provides an integrated ldap backend as a database if you are in this situation. You don't need this step.
>

After installing `krb5-kdc-ldap`, you should find the kerberos schema in `/usr/share/doc/krb5-kdc-ldap/kerberos.schema.gz`

```shell
# copy and unzip the schema
sudo cp /usr/share/doc/krb5-kdc-ldap/kerberos.schema.gz /etc/ldap/schema/
sudo gunzip /etc/ldap/schema/kerberos.schema.gz

# convert the schema into ldif format, then load the schema to ldap server
sudo apt install schema2ldif
sudo ldap-schema-manager -i kerberos.schema
# now you should see below output
# SASL/EXTERNAL authentication started
# SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
# SASL SSF: 0
# executing 'ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/kerberos.ldif'
# SASL/EXTERNAL authentication started
# SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
# SASL SSF: 0
# adding new entry "cn=kerberos,cn=schema,cn=config"
```

### bkp

```shell
sudo apt install  krb5-pkinit libsasl2-modules-gssapi-mit
```

- krb5-pkinit: This package enables `PKINIT (Public Key Cryptography for Initial Authentication)` in Kerberos. 
          PKINIT allows Kerberos authentication `using X.509 certificates instead of passwords`, which is useful for 
          environments that require `smart card login` or `certificate-based authentication`.

- libsasl2-modules-gssapi-mit: This package provides the GSSAPI (Generic Security Services Application Program Interface) 
     module for SASL (Simple Authentication and Security Layer) using the MIT Kerberos implementation.
