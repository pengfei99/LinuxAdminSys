# Configure debian server sshd auth with pam, sssd, kerberos

There is a complete tutorial on how to setup openldap, kerberos for unified authentication. You can visit
this [website](https://www.infoq.cn/article/s1ngm7eubqer9bw8xhk4).

In this tutorial, we show a scenario light compares to the architecture which shows in the above tutorial. 
We don't use the `SASL/GSSAPI` to delegate user password check to kerberos.

It means, in the below tutorial, user has a password in openldap, and a password in kerberos, which are not synchronized
automatically. The **user id** does the link of user between openldap and kerberos.


Suppose we have a ldap and kerberos server running on `10.50.5.200` with url as `krb.casd.local`.

suppose we have three servers:
- krb.casd.local: server hosts openldap and kerberos (can be replaced by AD/kerberos)
- ssh-server.casd.local: server runs sshd server which uses pam, sssd, sssd-krb5 to check user authentication
- ssh-client.casd.local: a vm runs an ssh client and krb5-client, user can get a kerberos ticket, and use this ticket to ssh
                           into the ssh-server.casd.local

The full authentication process:
1. user get a kerberos ticket (kinit <user-principal>) (in ssh-client.casd.local)
2. user init an ssh connection with the cached kerberos ticket(ssh uid@ssh-server.casd.local) (in ssh-client.casd.local)
3. ssh-server receives the ssh connection requests (sshd config checks all the possible authentication methods) (in ssh-server.casd.local)
4. `sshd` delegate the authentication to `pam`, `pam` delegate to `sssd`, `sssd` delegate to `sssd-krb5`. Because we set `auth_provider`
      as `krb5` in `sssd`. (in ssh-server.casd.local)
5. `sssd-krb5` sends a request to `krb.casd.local` to verify the authenticity of the kerberos ticket. This steps requires `ssh-server.casd.local`
    has a valid principal in `krb.casd.local` (in ssh-server.casd.local)
6. `krb.casd.local` verify the ticket and send the result back to `ssh-server.casd.local`. (in krb.casd.local)
7. `sssd-krb5` in `ssh-server.casd.local` receives the result, if ok, it will ask the `id_provider` of the `sssd`, 
      in our case it's `openldap` to get `uid` and `gid` of the user with the uid of the kerberos ticket. The user
      `uid` and `gid` information will be transfer to `nss`. `sssd` tells pam it's ok, `pam` tells sshd it's ok.
     Then pam will create a user session in the server after user login. (in ssh-server.casd.local)
8. user will get a terminal on `ssh-server.casd.local` with uid and gids from the `openldap` account.

## 1. Configure and test krb client on ssh-client.casd.local and ssh-server.casd.local

We need to install the kerberos client on both servers:
- ssh-client.casd.local
- ssh-server.casd.local

### 1.1 Install the required packages

```shell
# krb client package
sudo apt install krb5-user
```

### 1.2 Configure the krb client

```shell
sudo vim /etc/krb5.conf

# add the below content
[libdefaults]
	default_realm = CASD.LOCAL

# The following krb5.conf variables are only for MIT Kerberos.
	kdc_timesync = 1
	ccache_type = 4
	forwardable = true
	proxiable = true
        rdns = false


# The following libdefaults parameters are only for Heimdal Kerberos.
	fcc-mit-ticketflags = true

[realms]
	CASD.LOCAL = {
		kdc = krb.casd.local
		admin_server = krb.casd.local
	}
        

[domain_realm]
        casd.local = CASD.LOCAL
        .casd.local = CASD.LOCAL

```

### 1.3 Test the client

```shell
# generate a ticket, the principal must exist in the krb server
kinit pliu@CASD.LOCAL

# normally, you can view the ticket
klist

# clean the ticket
kdestory
```

## 2. Config sshd, pam, sssd on ssh-server.casd.local

### Install required packages

```shell
sudo apt install 


```

```shell
[sssd]
services = nss, pam
domains = casd.local
config_file_version = 2

[domain/casd.local]
id_provider = ldap
ldap_uri = ldap://krb.casd.local
ldap_search_base = dc=casd,dc=local

auth_provider = krb5
krb5_realm = CASD.LOCAL
debug_level = 5
krb5_validate = true
krb5_ccachedir = /var/tmp # note that RHEL-7 default to KERNEL ccaches, which are preferred in most cases to FILE
krb5_keytab = /etc/krb5.keytab
cache_credentials = true

override_homedir = /home/%u
default_shell = /bin/bash


[nss]
homedir_substring = /home

[pam]

```